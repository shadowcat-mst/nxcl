use NXCL::Package;
use NXCL::DocRender;
use CPAN::Meta::YAML qw(Load);

my $str = do { local $/; <STDIN> };

die unless $str =~ s/\A---\n(.*?)---\n//s;

my $meta = Load($1);

my $render = $meta->{'render-block'};

sub parse_block ($block) {
  my $code = $block =~ s/^    [$ ] //mgr;
  my $y = render($render, $code);
  return $y =~ s/^/      /mgr =~ s/\A     /    </r;
}

$str =~ s/((?:^    .*\n)+)/$1.parse_block($1)/emg;

print $str;
