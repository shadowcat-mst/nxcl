use NXCL::Package;
use NXCL::Environment;

my $fh = do {
  if (my $file = $ARGV[0]) {
    open my $fh, '<', $file or die "Couldn't open ${file}: $!";
    $fh;
  } else {
    \*STDIN;
  }
};

my $data = do { local $/; <$fh> };

while ($data =~ m/^(\$ .*\n(?:  .*\n)*)/mg) {
  my $env = NXCL::Environment->new;
  my $orig = $1;
  my $expr = $orig =~ s/^..//mgr;
  my $rv = $env->eval_string($expr)->value_to_xcl_string;
  print $orig;
  say '= '.$rv->xcl_raw_value;
}
