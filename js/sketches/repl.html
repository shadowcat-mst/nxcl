<html>
<head>
<link rel="stylesheet" href="/css/base.css" />
<script type="module">
import { Transcript } from "./transcript.js";
import { setHiddenProp } from '../src/util/objects.js';
import { preact, mobx } from '../src/web/libs.js';
import { EvaluationSeq } from '../src/web/views/evaluations.js';
import { VFrame } from '../src/web/views/vframe.js';
import { SelectField } from '../src/web/views/field/select.js';
import { nexusFromWebSocket } from '../src/stupidrpc/websocket.js';
import { Reactive } from '../src/web/reactive.js';
import { View, subviews } from '../src/web/viewcore.js';

const nexus = await nexusFromWebSocket(
  'ws://mallet3.scsys.co.uk:4172/ws',
  { prefix: 'client:' }
)

const server = Object.fromEntries([ 'list', 'load', 'save' ].map(
  name => [ name, (...args) => nexus.call(name, ...args) ]
))

const model = new (Reactive(Object, {
  transcriptName: 'default',
  get transcript () {
    const { transcriptName } = this
    const evaluations = mobx.observable([])
    mobx.flow(function* transcriptSetup () {
      evaluations.push(...yield server.load(transcriptName))
      const $reaction = 'transcript$evaluations$reaction'
      if (this[$reaction]) this[$reaction].dispose()
      const track = () => reaction.track(
        () => evaluations.map(v => v.code)
      )
      const reaction = setHiddenProp(this, $reaction, new mobx.Reaction(
        [ this.constructor.name, $reaction ].join('().'),
        () => {
          const data = evaluations.map(v => ({ code: v.code }))
          server.save(transcriptName, data)
                .then(track)
        }
      ))
      track()
    }).call(this)
    return new Transcript({ evaluations })
  },
}))()

const picker = new (class Picker extends SelectField {
  get selectedValue () { return this.model.transcriptName }
  set selectedValue (v) { this.model.transcriptName = v }
})({
  model,
  attrs: { name: 'transcript' },
  options: (await server.list()).map(v => ({ value: v, content: v })),
})

const view = new (Reactive(View, subviews({
  transcript: EvaluationSeq,
})))({
  model, picker,
  render () {
    const { transcript, picker, h: { div, hr } } = this
    return [
      div(picker),
      hr(),
      div(transcript),
    ]
  }
})

preact.render(preact.h(view), document.body);
</script>
</head>
<body>
</body>
</html>
